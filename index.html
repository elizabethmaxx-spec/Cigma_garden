<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CIGMA Garden: Love Machine Update</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: #0a0f0a; color: white; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        #auth-screen { position: fixed; inset: 0; background: #0a0f0a; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: #152015; padding: 25px; border-radius: 20px; border: 2px solid #4cd964; width: 100%; max-width: 300px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; background: #000; color: white; outline: none; }

        #ui-top { width: 100%; padding: 10px; display: flex; justify-content: space-around; align-items: center; font-weight: bold; background: #152015; border-bottom: 3px solid #4cd964; position: sticky; top: 0; z-index: 2000; }
        #weather-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500; transition: 1s; }
        .container { width: 100%; max-width: 500px; margin: auto; padding: 10px; height: 92vh; overflow-y: auto; }

        #love-machine { background: linear-gradient(135deg, #440a16, #22050b); border: 2px solid #ff4d6d; border-radius: 18px; padding: 15px; margin-bottom: 15px; text-align: center; box-shadow: 0 0 15px rgba(255, 77, 109, 0.3); }
        .recipe-item { display: inline-block; width: 45px; height: 45px; line-height: 45px; background: rgba(0,0,0,0.4); border-radius: 10px; margin: 5px; font-size: 24px; border: 2px solid #555; cursor: pointer; transition: 0.3s; }
        .recipe-item.ready { border-color: #ff4d6d; background: rgba(255, 77, 109, 0.2); box-shadow: 0 0 10px #ff4d6d; }

        #garden-area { position: relative; width: 100%; background: #2b1d10; border-radius: 20px; border: 4px solid #3e2723; padding: 15px; min-height: 380px; }
        #garden-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; position: relative; z-index: 10; }
        
        .plot { aspect-ratio: 1/1; background: #5d4037; border-radius: 12px; border: 3px solid #3e2723; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; position: relative; transition: 0.3s; }
        .plot.watered { border-color: #2196f3; box-shadow: inset 0 0 15px rgba(33,150,243,0.5); }
        .plot.mutated { border-color: #ff00ff; box-shadow: 0 0 15px #ff00ff; }

        .grow-timer { position: absolute; top: 2px; font-size: 11px; background: rgba(0,0,0,0.8); padding: 1px 5px; border-radius: 4px; color: #4cd964; }
        .mut-name { position: absolute; bottom: 2px; font-size: 9px; color: #ffeb3b; font-weight: bold; text-align: center; width: 100%; text-shadow: 1px 1px #000; }
        .live-pet { position: absolute; font-size: 38px; z-index: 25; transition: all 2.5s ease-in-out; cursor: pointer; pointer-events: auto; }

        #pet-profile { position: fixed; right: -300px; top: 0; width: 280px; height: 100%; background: #0d140d; z-index: 3000; transition: 0.4s; padding: 25px; border-left: 4px solid #4cd964; }
        #pet-profile.open { right: 0; }

        .section { background: #161616; padding: 12px; border-radius: 18px; margin-top: 15px; border: 1px solid #2a2a2a; }
        .inv-grid { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; min-height: 90px; }
        .inv-slot { min-width: 70px; height: 70px; background: #222; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid #333; font-size: 28px; cursor: pointer; position: relative; }
        .inv-slot.selected { border-color: #4cd964; background: #1a2a1a; }

        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
        .card { background: #1e2e1e; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #333; font-size: 13px; }
        .btn { width: 100%; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 6px; }
        .btn-buy { background: #4cd964; color: #000; }
        .btn-sell { background: #ff9800; color: #000; }

        .notif-badge { background: #ff3b30; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; position: absolute; top: -5px; right: -5px; display: none; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 4000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.open { display: flex; }
        .friend-item { background: #000; padding: 10px; border-radius: 10px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #4cd964; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 style="color: #4cd964; margin-top:0;">GARDEN LOGIN</h2>
            <input type="text" id="username" class="auth-input" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="password" id="password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn btn-buy" onclick="login()">–ò–ì–†–ê–¢–¨</button>
        </div>
    </div>

    <div id="modal-notif" class="modal-overlay">
        <div class="auth-card" style="width: 100%;">
            <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
            <div id="notif-list" style="text-align: left; max-height: 200px; overflow-y: auto;"></div>
            <button class="btn" style="background:#444;" onclick="closeModal('modal-notif')">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div id="modal-user" class="modal-overlay">
        <div class="auth-card" style="width: 100%;">
            <h2 id="prof-nick" style="color:#4cd964; margin:0;"></h2>
            <hr border="0" height="1" bgcolor="#333" style="margin:15px 0;">
            <p>üí∞ –ú–æ–Ω–µ—Ç—ã: <span id="prof-coins"></span></p>
            <p>üíß –í–æ–¥–∞: <span id="prof-water"></span></p>
            <p>üêæ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ç—ã: <span id="prof-pets"></span></p>
            <button class="btn" style="background:#444;" onclick="closeModal('modal-user')">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div id="weather-overlay"></div>

    <div id="ui-top">
        <div id="w-ui">üå§Ô∏è –Ø—Å–Ω–æ</div>
        <div onclick="openUserProfile()" style="cursor:pointer; position:relative;">
            üë§ <span id="user-display" style="color:#4cd964"></span>
        </div>
        <div onclick="openNotifs()" style="cursor:pointer; position:relative; font-size: 18px;">
            üîî <div id="notif-count" class="notif-badge">0</div>
        </div>
        <div>üí∞ <span id="coins">500</span></div>
        <div>üíß <span id="water">25</span></div>
    </div>

    <div id="pet-profile">
        <div onclick="closeProfile()" style="float:right; cursor:pointer;">‚úï</div>
        <div id="p-icon" style="font-size:70px; text-align:center; margin-top:40px;"></div>
        <h2 id="p-name" style="text-align:center;"></h2>
        <p id="p-desc" style="font-size:14px; color:#ccc;"></p>
        <button class="btn" style="background:#4cd964" onclick="applyPet()">–í–´–ü–£–°–¢–ò–¢–¨</button>
    </div>

    <div class="container">
        <div id="love-machine">
            <strong style="color:#ff4d6d">üíñ LOVE MACHINE</strong><br>
            <div id="recipe-display" style="margin: 10px 0;"></div>
            <button id="craft-btn" class="btn" style="display:none; background:#ff4d6d; color:white; border: 2px solid #fff;" onclick="startCraft()">–ö–†–ê–§–¢ LOVE SEED (30—Å)</button>
        </div>

        <div id="garden-area">
            <div id="garden-grid">
                <script>for(let i=0; i<9; i++) document.write(`<div class="plot" id="plot-${i}" onclick="interactPlot(${i})"></div>`);</script>
            </div>
        </div>

        <div class="section">
            <strong>–ò–ù–í–ï–ù–¢–ê–†–¨ (<span id="pet-count">0</span>/3 –ø–µ—Ç–∞)</strong>
            <div id="inv-items" class="inv-grid"></div>
        </div>

        <div class="section">
            <strong style="color:#4cd964">üë• –î–†–£–ó–¨–Ø</strong>
            <div style="display:flex; gap:5px; margin-top:8px;">
                <input type="text" id="friend-name" class="auth-input" style="margin:0; flex:1;" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞">
                <button class="btn btn-buy" style="width:auto; margin:0;" onclick="sendRequest()">+</button>
            </div>
            <div id="friends-list"></div>
        </div>

        <div class="section" style="border-color: #2196f3;">
            <strong style="color:#2196f3">GEAR SHOP</strong>
            <div class="market-grid">
                <div class="card">üíß –í–æ–¥–∞ (10 —à—Ç)<br>40üí∞ <button class="btn btn-buy" onclick="buyGear('water', 40, 10)">–ö–£–ü–ò–¢–¨</button></div>
                <div class="card">üßπ –õ–æ–ø–∞—Ç–∞ (–ë–µ—Å–∫.)<br>50üí∞ <button class="btn btn-buy" onclick="buyGear('shovel', 50, 1)">–ö–£–ü–ò–¢–¨</button></div>
            </div>
        </div>

        <div class="section">
            <strong>–°–¢–û–ö –°–ï–ú–Ø–ù (<span id="shop-timer">120</span>—Å)</strong>
            <div class="market-grid" id="seed-stock-display"></div>
            <button class="btn" style="background:#8a2be2; color:white" onclick="buyEgg()">–ö–£–ü–ò–¢–¨ –Ø–ô–¶–û (150üí∞)</button>
        </div>

        <div class="section">
            <strong>–†–´–ù–û–ö</strong>
            <div id="sell-market" class="market-grid"></div>
        </div>
        
        <button class="btn" style="background: #333; color: white; margin-top: 20px;" onclick="logout()">–í–´–ô–¢–ò</button>
    </div>

<script>
    let currentUser = null;
    let coins = 500, water = 25, selectedIdx = null;
    let plots = Array(9).fill(null);
    let inventory = [], activePets = [], currentStock = [];
    let friends = [], notifications = [];
    let currentWeather = { name: '–Ø—Å–Ω–æ', id: 'clear', mult: 1, color: 'transparent', icon: 'üå§Ô∏è' };

    let recipe = ['ü•ï', 'üçé', 'üéÉ'];
    let recipeStatus = [false, false, false];

    const SEEDS = [
        { icon: 'ü•ï', name: '–ú–æ—Ä–∫–æ–≤—å', price: 10, sell: 25, time: 10 },
        { icon: 'üéÉ', name: '–¢—ã–∫–≤–∞', price: 30, sell: 85, time: 25 },
        { icon: 'üåµ', name: '–ö–∞–∫—Ç—É—Å', price: 70, sell: 210, time: 50 },
        { icon: 'üå∏', name: 'Candy', price: 400, sell: 1500, time: 100 },
        { icon: 'üå≥', name: '–Ø–±–ª–æ–Ω—è', price: 500, sell: 350, time: 60, isPermanent: true } 
    ];

    const PETS = {
        'üê±': { name: '–ö–æ—Ç', desc: '–î–∞–µ—Ç +25üí∞ –∫–∞–∂–¥—ã–µ 20—Å', effect: 'money' },
        'ü¶â': { name: '–°–æ–≤–∞', desc: '–î–∞–µ—Ç +4üíß –∫–∞–∂–¥—ã–µ 20—Å', effect: 'water' },
        'ü¶ù': { name: '–ï–Ω–æ—Ç', desc: '–ü—Ä–∏–Ω–æ—Å–∏—Ç —Ñ—Ä—É–∫—Ç—ã –∫–∞–∂–¥—ã–µ 40—Å', effect: 'fruit' },
        'üêù': { name: '–°—Ç—Ä–µ–∫–æ–∑–∞', desc: '–ó–æ–ª–æ—Ç–∞—è –º—É—Ç–∞—Ü–∏—è (—Ö1.75)', effect: 'mutate' }
    };

    const WEATHER_TYPES = [
        { name: '–î–æ–∂–¥—å', id: 'rain', mult: 1.2, color: 'rgba(0,100,255,0.15)', icon: 'üåßÔ∏è', mut: '–°–æ—á–Ω—ã–π' },
        { name: '–°–Ω–µ–≥', id: 'snow', mult: 1.4, color: 'rgba(255,255,255,0.15)', icon: '‚ùÑÔ∏è', mut: '–õ–µ–¥—è–Ω–æ–π' },
        { name: '–†–∞–¥–∏–∞—Ü–∏—è', id: 'nuke', mult: 2.2, color: 'rgba(50,255,50,0.15)', icon: '‚ò¢Ô∏è', mut: '–ú—É—Ç–∞–Ω—Ç' },
        { name: '–°–∏—è–Ω–∏–µ', id: 'gold', mult: 3.0, color: 'rgba(255,215,0,0.2)', icon: '‚ú®', mut: '–°–≤—è—Ç–æ–π' }
    ];

    function updateRecipeUI() {
        const d = document.getElementById('recipe-display');
        d.innerHTML = '';
        recipe.forEach((icon, i) => {
            const s = document.createElement('div');
            s.className = 'recipe-item' + (recipeStatus[i] ? ' ready' : '');
            s.innerHTML = icon;
            s.onclick = () => fillSlot(i);
            d.appendChild(s);
        });
        document.getElementById('craft-btn').style.display = recipeStatus.every(v => v) ? 'inline-block' : 'none';
    }

    function fillSlot(i) {
        if(recipeStatus[i]) return;
        const iconNeeded = recipe[i];
        const idx = inventory.findIndex(it => it.icon === iconNeeded && it.type === 'fruit');
        if(idx > -1) {
            inventory.splice(idx, 1);
            recipeStatus[i] = true;
            updateUI(); updateRecipeUI();
        } else { alert("–ù—É–∂–µ–Ω —Ñ—Ä—É–∫—Ç: " + iconNeeded); }
    }

    function startCraft() {
        const btn = document.getElementById('craft-btn');
        btn.disabled = true;
        let t = 30;
        const itv = setInterval(() => {
            t--;
            btn.innerText = `–ü–†–û–¶–ï–°–°... ${t}—Å`;
            if(t <= 0) {
                clearInterval(itv);
                inventory.push({ icon: 'üíñ', name: 'Love Seed', type: 'seed', time: 60, sell: 2500, label: '–õ–µ–≥–µ–Ω–¥–∞' });
                recipeStatus = [false, false, false];
                btn.disabled = false; btn.innerText = "–ö–†–ê–§–¢ LOVE SEED";
                updateUI(); updateRecipeUI();
            }
        }, 1000);
    }

    function login() {
        const u = document.getElementById('username').value.trim().toLowerCase();
        const p = document.getElementById('password').value.trim();
        if(!u || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
        currentUser = u;
        const saved = localStorage.getItem('garden_v2_' + u);
        if(saved) {
            const data = JSON.parse(saved);
            if(data.password !== p) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
            coins = data.coins; water = data.water; inventory = data.inventory || []; plots = data.plots || Array(9).fill(null); 
            activePets = data.activePets || []; friends = data.friends || []; notifications = data.notifications || [];
        } else { saveGame(p); }
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('user-display').innerText = currentUser;
        initGame();
    }

    function saveGame(pass) {
        if(!currentUser) return;
        let currentPass = pass;
        const savedStr = localStorage.getItem('garden_v2_' + currentUser);
        if(!currentPass && savedStr) currentPass = JSON.parse(savedStr).password;
        const data = { 
            password: currentPass, coins, water, inventory, plots, friends, notifications,
            activePets: activePets.map(p => ({ id: p.id, icon: p.icon, name: p.name, desc: p.desc, effect: p.effect })) 
        };
        localStorage.setItem('garden_v2_' + currentUser, JSON.stringify(data));
    }

    function initGame() {
        updateStock(); updateUI(); updateRecipeUI();
        activePets.forEach(p => spawnPetSprite(p));
        setInterval(() => saveGame(), 5000);
        setInterval(() => { if(currentUser) updateWeather(); }, 30000);
        setInterval(() => {
            const dataRaw = localStorage.getItem('garden_v2_' + currentUser);
            if(dataRaw) {
                const data = JSON.parse(dataRaw);
                if(data.notifications.length !== notifications.length) { 
                    notifications = data.notifications; 
                    updateUI(); 
                }
            }
        }, 3000);
    }

    function interactPlot(i) {
        const p = plots[i];
        const sel = inventory[selectedIdx];
        const el = document.getElementById(`plot-${i}`);
        if (sel && sel.type === 'tool' && sel.name === '–õ–æ–ø–∞—Ç–∞') {
            if (p) { plots[i] = null; el.innerHTML = ''; el.className = 'plot'; updateUI(); return; }
        }
        if(!p && sel && sel.type === 'seed') {
            let mut = (currentWeather.id !== 'clear' && Math.random() < 0.4) ? currentWeather : null;
            plots[i] = { ...sel, timeLeft: sel.time, stage: 0, watered: false, weatherMut: mut, isGolden: false };
            inventory.splice(selectedIdx, 1); selectedIdx = null; updateUI();
        } 
        else if(p && !p.watered && water > 0 && p.stage < 2) {
            water--; p.watered = true; updateUI();
        } 
        else if(p && p.stage === 2) {
            let finalPrice = p.sell;
            if(p.weatherMut) finalPrice = Math.floor(finalPrice * p.weatherMut.mult);
            if(p.isGolden) finalPrice = Math.floor(finalPrice * 1.75);
            inventory.push({ icon: (p.name === '–Ø–±–ª–æ–Ω—è' ? 'üçé' : p.icon), type: 'fruit', sell: finalPrice, label: p.isGolden ? '–ó–æ–ª–æ—Ç–æ–π' : (p.weatherMut ? p.weatherMut.mut : '') });
            if (p.isPermanent) { p.timeLeft = p.time; p.stage = 0; p.watered = false; p.isGolden = false; p.weatherMut = null; } 
            else { plots[i] = null; el.innerHTML = ''; el.className = 'plot'; }
            updateUI();
        }
    }

    setInterval(() => {
        if(!currentUser) return;
        plots.forEach((p, i) => {
            if(!p || p.stage >= 2) return;
            p.timeLeft -= (p.watered ? 2 : 1) / 10;
            if(p.timeLeft <= p.time * 0.5 && p.stage === 0) p.stage = 1;
            if(p.timeLeft <= 0) { p.timeLeft = 0; p.stage = 2; }
            const el = document.getElementById(`plot-${i}`);
            el.className = 'plot' + (p.watered ? ' watered' : '') + ((p.weatherMut || p.isGolden) ? ' mutated' : '');
            let visual = p.stage === 0 ? 'üå±' : (p.stage === 1 ? 'üåø' : p.icon);
            let lbl = p.isGolden ? '–ó–û–õ–û–¢–û–ô' : (p.weatherMut ? p.weatherMut.mut : '');
            el.innerHTML = (p.stage < 2 ? `<div class="grow-timer">${Math.ceil(p.timeLeft)}s</div>` : '') + visual + (lbl ? `<div class="mut-name">${lbl}</div>` : '');
        });
    }, 100);

    function spawnPetSprite(pObj) {
        const sprite = document.createElement('div');
        sprite.className = 'live-pet'; sprite.id = 'p-' + pObj.id; sprite.innerText = pObj.icon;
        sprite.onclick = (e) => { e.stopPropagation(); removePet(pObj.id); };
        document.getElementById('garden-area').appendChild(sprite);
        const move = () => { const s = document.getElementById('p-'+pObj.id); if(s){ s.style.left=Math.random()*80+'%'; s.style.top=Math.random()*70+'%'; }};
        move(); pObj.timer = setInterval(move, 4000);
        pObj.effTimer = setInterval(() => {
            if(pObj.effect === 'money') coins += 25;
            if(pObj.effect === 'water') water += 4;
            if(pObj.effect === 'fruit') {
                const loot = [{i:'üçé',p:45},{i:'ü•ï',p:20},{i:'üéÉ',p:70}][Math.floor(Math.random()*3)];
                inventory.push({ icon: loot.i, type: 'fruit', sell: loot.p, label: '–£–∫—Ä–∞–¥–µ–Ω–æ' });
            }
            if(pObj.effect === 'mutate') {
                const r = plots.filter(pl => pl && pl.stage === 2 && !pl.isGolden);
                if(r.length > 0) r[Math.floor(Math.random()*r.length)].isGolden = true;
            }
            updateUI();
        }, 25000);
    }

    function removePet(id) {
        const idx = activePets.findIndex(p => p.id === id);
        if(idx > -1) {
            const p = activePets[idx];
            clearInterval(p.timer); clearInterval(p.effTimer);
            if(document.getElementById('p-' + id)) document.getElementById('p-' + id).remove();
            inventory.push({ icon: p.icon, type: 'pet', name: p.name, desc: p.desc, effect: p.effect });
            activePets.splice(idx, 1); updateUI();
        }
    }

    function applyPet() {
        if(activePets.length >= 3) return alert("–ú–∞–∫—Å–∏–º—É–º 3 –ø–µ—Ç–∞!");
        const pet = inventory[selectedIdx];
        if(pet && pet.type === 'pet') {
            const newPet = { ...pet, id: Date.now() };
            activePets.push(newPet); spawnPetSprite(newPet);
            inventory.splice(selectedIdx, 1); selectedIdx = null; closeProfile(); updateUI();
        }
    }

    function updateUI() {
        document.getElementById('coins').innerText = coins;
        document.getElementById('water').innerText = water;
        document.getElementById('pet-count').innerText = activePets.length;
        const nBadge = document.getElementById('notif-count');
        if(notifications.length > 0) { nBadge.innerText = notifications.length; nBadge.style.display = 'block'; }
        else { nBadge.style.display = 'none'; }

        const grid = document.getElementById('inv-items'); grid.innerHTML = '';
        inventory.forEach((item, i) => {
            const slot = document.createElement('div');
            slot.className = 'inv-slot' + (selectedIdx === i ? ' selected' : '');
            slot.innerHTML = item.icon + (item.label && item.label !== '–£–∫—Ä–∞–¥–µ–Ω–æ' ? '‚ú®' : '');
            slot.onclick = () => { selectedIdx = i; if(item.type === 'pet') openProfile(item); else updateUI(); };
            grid.appendChild(slot);
        });

        const fl = document.getElementById('friends-list'); fl.innerHTML = '';
        friends.forEach(f => {
            const dRaw = localStorage.getItem('garden_v2_' + f);
            const d = dRaw ? JSON.parse(dRaw) : null;
            fl.innerHTML += `<div class="friend-item">üë§ ${f} <span style="color:#ffeb3b; font-size:12px;">${d ? d.coins : '???'}üí∞</span></div>`;
        });

        const sellBox = document.getElementById('sell-market'); sellBox.innerHTML = '';
        inventory.filter(it => it.type === 'fruit').forEach(it => {
            sellBox.innerHTML += `<div class="card">${it.icon} ${it.label || ''}<br>+${it.sell}üí∞<br><button class="btn btn-sell" onclick="sellOne(${inventory.indexOf(it)})">–ü–†–û–î–ê–¢–¨</button></div>`;
        });
    }

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –°–û–¶–ò–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function sendRequest() {
        const input = document.getElementById('friend-name');
        const target = input.value.trim().toLowerCase();
        if (!target) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫!");
        if (target === currentUser) return alert("–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è!");
        if (friends.includes(target)) return alert("–£–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö!");

        const targetDataRaw = localStorage.getItem('garden_v2_' + target);
        if (!targetDataRaw) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ!");

        let tObj = JSON.parse(targetDataRaw);
        if (!tObj.notifications) tObj.notifications = [];
        if (tObj.notifications.some(n => n.from === currentUser)) return alert("–ó–∞–ø—Ä–æ—Å —É–∂–µ –≤–∏—Å–∏—Ç!");

        tObj.notifications.push({ from: currentUser, id: Date.now() });
        localStorage.setItem('garden_v2_' + target, JSON.stringify(tObj));
        input.value = '';
        alert("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω " + target + "!");
    }

    function acceptFriend(id, fromUser) {
        if (!friends.includes(fromUser)) friends.push(fromUser);
        notifications = notifications.filter(n => n.id !== id);

        const senderDataRaw = localStorage.getItem('garden_v2_' + fromUser);
        if (senderDataRaw) {
            let sObj = JSON.parse(senderDataRaw);
            if (!sObj.friends) sObj.friends = [];
            if (!sObj.friends.includes(currentUser)) sObj.friends.push(currentUser);
            localStorage.setItem('garden_v2_' + fromUser, JSON.stringify(sObj));
        }
        saveGame(); updateUI(); closeModal('modal-notif');
    }

    function openNotifs() {
        const myDataRaw = localStorage.getItem('garden_v2_' + currentUser);
        if(myDataRaw) notifications = JSON.parse(myDataRaw).notifications || [];
        const list = document.getElementById('notif-list');
        list.innerHTML = notifications.length ? '' : '–ü—É—Å—Ç–æ';
        notifications.forEach(n => {
            list.innerHTML += `<div class="friend-item"><span>–û—Ç: ${n.from}</span><button class="btn btn-buy" style="width:auto; padding:5px" onclick="acceptFriend(${n.id}, '${n.from}')">–ü—Ä–∏–Ω—è—Ç—å</button></div>`;
        });
        document.getElementById('modal-notif').classList.add('open');
    }

    function openUserProfile() {
        document.getElementById('prof-nick').innerText = currentUser.toUpperCase();
        document.getElementById('prof-coins').innerText = coins;
        document.getElementById('prof-water').innerText = water;
        document.getElementById('prof-pets').innerText = activePets.length;
        document.getElementById('modal-user').classList.add('open');
    }

    function buyGear(t, c, a) { if(coins >= c) { if(t === 'shovel') { if(inventory.find(it => it.name === '–õ–æ–ø–∞—Ç–∞')) return alert("–£–∂–µ –µ—Å—Ç—å!"); inventory.push({ icon: 'üßπ', type: 'tool', name: '–õ–æ–ø–∞—Ç–∞' }); } else if(t==='water') { water += a; } coins -= c; updateUI(); } }
    function sellOne(idx) { coins += inventory[idx].sell; inventory.splice(idx, 1); updateUI(); }
    function openProfile(p) { document.getElementById('p-icon').innerText = p.icon; document.getElementById('p-name').innerText = p.name; document.getElementById('p-desc').innerText = p.desc; document.getElementById('pet-profile').classList.add('open'); }
    function closeProfile() { document.getElementById('pet-profile').classList.remove('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    function buyEgg() { if(coins >= 150) { coins -= 150; const k = Object.keys(PETS); const icon = k[Math.floor(Math.random()*k.length)]; inventory.push({ icon, type: 'pet', ...PETS[icon] }); updateUI(); } }
    function updateStock() {
        const d = document.getElementById('seed-stock-display'); d.innerHTML = ''; currentStock = [];
        for(let i=0; i<2; i++) {
            const s = SEEDS[Math.floor(Math.random()*SEEDS.length)]; currentStock.push(s);
            d.innerHTML += `<div class="card">${s.icon} ${s.name}<br>${s.price}üí∞<button class="btn btn-buy" onclick="buyFromStock(${i})">–ö–£–ü–ò–¢–¨</button></div>`;
        }
    }
    function buyFromStock(i) { const s = currentStock[i]; if(coins >= s.price) { coins -= s.price; inventory.push({...s, type:'seed'}); updateUI(); } }
    function logout() { location.reload(); }
    let shopSec = 120;
    setInterval(() => { if(currentUser) { shopSec--; document.getElementById('shop-timer').innerText = shopSec; if(shopSec <= 0) { shopSec = 120; updateStock(); } } }, 1000);
    function updateWeather() {
        currentWeather = (Math.random() < 0.3) ? WEATHER_TYPES[Math.floor(Math.random()*WEATHER_TYPES.length)] : { name: '–Ø—Å–Ω–æ', id: 'clear', mult: 1, color: 'transparent', icon: 'üå§Ô∏è' };
        document.getElementById('w-ui').innerText = currentWeather.icon + ' ' + currentWeather.name;
        document.getElementById('weather-overlay').style.background = currentWeather.color;
    }
</script>
</body>
</html>
